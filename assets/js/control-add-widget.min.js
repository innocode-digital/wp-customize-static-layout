!function(t,e,n,i,o){"use strict";var s=e.customize;s.controlConstructor[i.type]=s.Control.extend({getWidgetIndexes:function(){var t=n.keys(this.setting());return t.length?n.filter(n.map(t,function(t){return parseInt(t,10)}),function(t){return!isNaN(t)}).sort():[]},getLastWidgetIndex:function(){return this.getWidgetIndexes().length?n.max(this.getWidgetIndexes()):-1},getParentContainer:function(){var t=s.section(this.section());return t.contentContainer.is("ul")?t.contentContainer:t.contentContainer.find("ul:first")},addWidget:function(){var t=this.setting.id,e=n.clone(s.section(t).params),i=e.id+"["+this.index+"]";return n.forEach(s.section(t).controls(),function(e){e=this.addControl(i,e),s(e.id).bind(function(i,o){var d=s(t),r=d.get(),a=n.clone(r);n.isArray(a)||(a=[]),n.isObject(a[i])||(a[i]={}),a[i][e.name]=o,d.set(a),d.callbacks.fireWith(d,[a,r])}.bind(this,this.index))}.bind(this)),delete e.id,delete e.instanceNumber,e.title+=" #"+(this.index+1),s.section.add(new s.OuterSection(i,e)),this.addEditButton(i),this.index+=1,i},addControl:function(e,i){var o=this.setting(),d=n.extend({},i.params,{section:e}),r=d.settings.default,a=r.replace(/([^[]+\[\d+]\[[^\[]+])(\[\w+])$/g,"$1["+this.index+"]$2"),c=r.replace(/[^[]+\[\d+]\[[^\[]+]\[(\w+)]$/g,"$1"),l=n.clone(s.settings.settings[r]),u="",h={};return delete l.value,n.has(o,this.index)&&n.has(o[this.index],c)&&(u=o[this.index][c]),s.add(new s.Setting(a,u,l)),n.contains(["select"],d.type)&&(t(d.content).find("option").each(function(e,n){var i=t(n);h[i.attr("value")]=i.html()}),d.choices=h),delete d.content,delete d.settings,delete d.instanceNumber,d.setting=a,s.control.add(new s.Control(a,d)),{id:a,name:c}},addEditButton:function(t){var e="_"+this.setting.id,i=n.extend({},s.control(e).params,{active:!0}),d=n.clone(s.settings.settings[e]);return delete d.value,s.add(new s.Setting(t,null,d)),delete i.content,delete i.settings,delete i.instanceNumber,i.setting=t,s.control.add(new s.controlConstructor[o.type](t,i)),t},initializeSortable:function(){var t=this.getParentContainer();return t.sortable({handle:"."+i.namespace+"-sort-widget-button",items:"> li.customize-control-"+i.namespace+"_edit_widget",cancel:"input,textarea,button:not(."+i.namespace+"-sort-widget-button),select,option",stop:this._onSort.bind(this)}),t.disableSelection(),this},_onClick:function(t){return t.preventDefault(),s.section(this.addWidget()).expand(),this},_onSort:function(){var t=this.getParentContainer(),e=t.find("> li.customize-control-"+i.namespace+"_edit_widget").filter(":visible"),o=n.filter(s.section(this.section()).controls(),function(t){return 0===t.id.lastIndexOf(this.id+"[",0)}.bind(this)),d={};return n.forEach(o,function(t){n.reduce(s.section(t.id).controls(),function(t,e){return t[e.id]=s(e.id).get(),t},d)}),n.forEach(o,function(t){var i=e.index(t.container),o=s.section(t.id);o.expanded()&&o.collapse(),n.forEach(o.controls(),function(t){s(t.id.replace(/([^[]+\[\d+]\[[^\[]+])\[\d+](\[\w+])$/g,"$1["+i+"]$2")).set(d[t.id])})}),t.sortable("cancel"),this},ready:function(){var t,e=this.getLastWidgetIndex();return this.index=0,e>-1&&(t=this.addWidget.bind(this),n.forEach(n.range(e+1),t)),this.initializeSortable(),this.container.find(".button").on("click",this._onClick.bind(this)),this}})}(jQuery,window.wp,_,window.customizeStaticLayoutControlAddWidget,window.customizeStaticLayoutControlEditWidget);